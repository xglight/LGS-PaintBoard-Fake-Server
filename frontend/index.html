<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>ğŸ¨ å®æ—¶ç”»æ¿</title>
    <style>
        body {
            background: #222;
            color: #eee;
            text-align: center;
            font-family: monospace;
        }

        canvas {
            border: 2px solid #555;
            cursor: crosshair;
            margin-top: 10px;
        }

        #status {
            margin-top: 8px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <h1>ğŸ¨ å®æ—¶ç”»æ¿</h1>
    <canvas id="board" width="1000" height="600"></canvas>
    <div id="status">è¿æ¥ä¸­...</div>

    <script type="module">
        const config = {
            api: { host: "10.0.3.113", port: 3000, protocol: "http" },
            websocket: { host: "10.0.3.113", port: 3001, protocol: "ws" },
            board: { width: 1000, height: 600 }
        };

        const canvas = document.getElementById("board");
        const ctx = canvas.getContext("2d");
        const statusEl = document.getElementById("status");
        const WIDTH = config.board.width;
        const HEIGHT = config.board.height;
        let uid = 1;  // æµ‹è¯• UID
        let token = "";
        let ws;
        let nextId = 1;

        // ========== åŠ è½½ç”»æ¿ ==========
        async function loadBoard() {
            const url = `${config.api.protocol}://${config.api.host}:${config.api.port}/api/paintboard/getboard`;
            const res = await fetch(url);
            const buf = await res.arrayBuffer();
            const data = new Uint8Array(buf);
            const imgData = ctx.createImageData(WIDTH, HEIGHT);
            for (let y = 0; y < HEIGHT; y++) {
                for (let x = 0; x < WIDTH; x++) {
                    const i = (y * WIDTH + x) * 3;
                    const j = (y * WIDTH + x) * 4;
                    imgData.data[j] = data[i];
                    imgData.data[j + 1] = data[i + 1];
                    imgData.data[j + 2] = data[i + 2];
                    imgData.data[j + 3] = 255;
                }
            }
            ctx.putImageData(imgData, 0, 0);
            console.log("Board loaded");
        }

        // ========== è¿æ¥ WebSocket ==========
        function connectWS() {
            const wsUrl = `${config.websocket.protocol}://${config.websocket.host}:${config.websocket.port}?readonly=1`;
            ws = new WebSocket(wsUrl);
            ws.binaryType = "arraybuffer";
            ws.onopen = () => {
                statusEl.textContent = "âœ… WebSocket å·²è¿æ¥ï½";
                console.log("WS connected");
            };
            ws.onclose = () => {
                statusEl.textContent = "âŒ è¿æ¥æ–­å¼€ï¼Œ3 ç§’åé‡è¿...";
                setTimeout(connectWS, 3000);
            };
            ws.onmessage = (event) => {
                const data = new Uint8Array(event.data);
                const type = data[0];
                if (type === 0xFA) {
                    // ç»˜åˆ¶å¹¿æ’­åŒ… S2C
                    const x = data[1] | (data[2] << 8);
                    const y = data[3] | (data[4] << 8);
                    const r = data[5], g = data[6], b = data[7];
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.fillRect(x, y, 1, 1);
                } else if (type === 0xFF) {
                    const id = data[1] | (data[2] << 8) | (data[3] << 16) | (data[4] << 24);
                    const code = data[5];
                    console.log("ç»˜åˆ¶ç»“æœ:", id, code.toString(16));
                } else if (type === 0xFC) {
                    // ping
                    ws.send(new Uint8Array([0xFB])); // pong
                }
            };
        }
        (async () => {
            await loadBoard();
            connectWS();
        })();
    </script>
</body>

</html>